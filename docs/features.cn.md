### 功能文档（中文）

#### 1. 定位与目标

NexusMQTT 是一款面向开发者与运维工程师的桌面 / Web 双模式 MQTT 客户端，重点解决以下问题：

- **统一管理多环境连接**：生产 / 测试 / 本地等多个 Broker 与连接集中管理。
- **可重复的调试场景**：主题、载荷模板、示例与 Schema 可长期保存、复用与共享。
- **真实系统联调与压测**：支持自动定时发布、历史回放与导出，方便排障和分析。

#### 2. 核心能力概览

- 多连接与分组工作区
- 托管 Broker 与身份（账号）
- 主题工作台（Topic Workbench）
- 消息日志与历史数据库
- AI 载荷生成（兼容 OpenAI）
- 配置导入/导出与备份
- 桌面 + Web 双运行模式
- 多语言与主题（中/英 + 明/暗）

---

#### 3. 多连接与工作区管理

**3.1 多连接管理**

- 在左侧边栏维护多个 Connection Profile，每个连接包含：
  - 名称、分组（Group）
  - 协议（`mqtt`/`mqtts`/`ws`/`wss`）
  - 主机、端口、路径（WS/WSS 默认 `/mqtt`）
  - Client ID、Keepalive、Clean Session 等参数
- 连接可直接配置 host，也可以绑定到某个 **Broker** 对象进行复用。

**3.2 连接分组与搜索**

- 连接支持按分组展示，例如 `Production` / `Staging` / `Local`。
- 分组可展开/折叠，并在侧边栏顶部通过搜索框按名称或主机过滤。
- 支持通过右键菜单或「快速操作」弹窗修改分组和名称。

**3.3 连接复制与快捷操作**

- 侧边栏聚焦时，使用 **Ctrl/Cmd + C / V**：
  - 在没有文本选中时，可复制当前连接，包括其主题目录。
- 右键连接弹出上下文菜单：
  - 重命名 / 移动分组 / 复制 / 编辑配置 / 删除连接。
- 删除连接时，可同时清理关联的历史记录与主题目录。

---

#### 4. 托管 Broker 与身份

**4.1 Broker 管理**

- 在 `SettingsModal` 的 `Brokers` 页面集中管理 Broker：
  - 协议：`mqtt` / `mqtts` / `ws` / `wss`
  - 主机、端口、路径（WS/WSS 默认 `/mqtt`）
  - 自动推导 SSL 与默认端口
- 连接可以通过 `brokerId` 引用特定 Broker，减少重复配置。

**4.2 身份管理（AuthIdentity）**

- 在 `Identities` 页面维护可复用身份：
  - 名称、用户名、密码、静态 Client ID。
- 连接可绑定身份，实现集中管理账号与凭据。

---

#### 5. 主题工作台（Topic Workbench）

**5.1 主题目录模型**

每个连接都有独立的主题目录 (`ConnectionTopicDocument`)：

- `topics` 为一组 `TopicCatalogItem`，包含：
  - `name`：显示名称
  - `topic`：MQTT 主题字符串
  - `direction`：`publish` / `subscribe` / `both`
  - `qos`：0 / 1 / 2
  - `retain`：是否保留消息
  - `contentType`：如 `application/json`
  - `description`：说明文案
  - `tags`：标签数组，支持搜索
  - `payloadTemplate`：模板载荷（一般为 JSON）
  - `payloadExample`：示例载荷
  - `schema`：JSON Schema 文本
- 文本字段提供 JSON 格式化操作，便于保持结构化。

**5.2 订阅与发布**

- 单个主题可一键：
  - 订阅/取消订阅（根据 `direction` 决定是否允许订阅）。
  - 使用 `payloadTemplate` 或 `payloadExample` 作为载荷发布。
- 右键主题弹出上下文菜单：
  - 订阅/取消订阅、使用模板/示例发布一次、开启/停止自动发布。

**5.3 自动定时发布（Auto Publish）**

- 对任意支持发布的主题，可配置自动发布任务：
  - `intervalSeconds`：发布间隔（秒）。
  - `stopMode`：
    - `manual`：手动停止；
    - `count`：固定次数后停止；
    - `until`：到达指定时间后停止。
  - 可从模板或示例中自动选择载荷字段。
- 提供预设时间（+2 / +5 / +10 / +60 分钟）快速设置截止时间。
- 正在运行的自动发布任务会在：
  - 连接断开；
  - 主题被删除；
  - 达到次数或时间；
  时自动停止并给出提示。

**5.4 主题目录导入/导出**

- 按连接导入/导出主题目录 JSON (`TopicCatalogFile`)：
  - 包含 `magic` 字段用于校验格式。
  - 支持版本号与时间戳。
- 导入前会弹出确认，避免误覆盖现有目录。

---

#### 6. 消息日志与历史

**6.1 实时消息日志（MessageLog）**

- 展示当前连接的入站 (`in`) 与出站 (`out`) 消息：
  - 时间戳（精确到毫秒）
  - 方向、QoS、保留标记
  - 主题、载荷内容（原文展示）
- 支持按主题与载荷的 **关键字过滤**。
- 可 **暂停自动滚动**，阅读历史时不会被新消息打断。
- 可对包含通配符的订阅进行「静音」，使其匹配的入站消息不再显示。

**6.2 订阅匹配与静音策略**

- 为每条消息尝试找到匹配的订阅：
  - 先精确匹配；
  - 再按 MQTT 通配符规则转换为正则进行匹配（`+` 单层、`#` 尾部多层）。
- 如果匹配的订阅被设置为 `muted`，则对应入站消息在日志中被隐藏。

**6.3 历史记录与分页加载**

- 桌面模式下，历史存储在本地 SQLite 数据库：
  - `history_query_latest`：按连接加载最新若干条。
  - `history_query_before`：按游标（时间戳 + ID）向前分页。
- UI 通过 `hasMoreOlder` 与 `isLoadingOlder` 控制向上滑动加载：
  - 滚动到顶部触发加载旧记录，并维持滚动位置稳定。
- 支持清空单个连接的历史记录。

**6.4 历史导出**

- 历史导出命令可将指定时间范围的消息导出为：
  - **NDJSON**：一行一条 JSON，适合日志系统与二次处理；
  - **CSV**：适合表格与 BI 工具。
- 桌面模式通过原生文件对话框选择输出路径。

---

#### 7. AI 载荷生成

**7.1 配置合并与校验**

- 运行时 AI 配置来源：
  - 全局默认配置（可由环境变量设置）；
  - 当前会话中用户在设置中填写的配置。
- Rust 后端会将两者合并（用户值优先），并严格校验：
  - API Key 是否非空；
  - Base URL 是否以 `http://` 或 `https://` 开头；
  - Model 是否非空字符串。

**7.2 生成逻辑**

- 后端会构造提示词，将 Topic 与简要描述传给 OpenAI 兼容端点，并要求：
  - 仅返回 JSON，不允许 Markdown 代码块。
- 对返回内容进行处理：
  - 去掉可能存在的代码块标记；
  - 尝试直接解析 JSON；
  - 如失败，扫描字符串中第一个完整的 JSON 对象/数组片段并解析；
  - 解析失败时返回明确错误信息。
- 最终以 **格式化的 JSON 字符串** 形式返回给前端，写入 `payloadTemplate` 字段。

---

#### 8. 应用配置与工作区

**8.1 配置内容**

- 应用配置对象 (`NativeAppConfig`) 包含：
  - 所有连接 Profile；
  - Brokers 与 Identities；
  - AI 配置；
  - 左侧边栏展开状态、当前语言与主题；
  - 当前激活连接 ID；
  - 每个连接的 Topic Document；
  - 发布模板集合等。

**8.2 自动保存与去抖**

- 前端监听关键状态变化（连接、Broker、身份、AI、主题目录等）：
  - 将配置序列化为 JSON；
  - 若与上一次保存内容不同，则在短延迟后调用 Rust 端 `save_app_config`。
- 避免高频写盘，提升性能与可靠性。

**8.3 导入/导出 App 配置**

- 导出配置：打包为带 `magic` 字段的 JSON，供备份或迁移。
- 导入配置：
  - 校验 `magic`；
  - 确认用户是否覆盖当前工作区；
  - 在必要时先断开所有活动连接；
  - 完整替换连接、Broker、身份、AI 配置、Topic Document 与激活连接。

---

#### 9. 运行模式与平台支持

- **桌面模式（Tauri）**：
  - 使用 Rust 实现 MQTT 连接、历史数据库、文件导入/导出等能力。
  - 提供本地路径访问、原生对话框与系统集成能力。
- **Web 模式（纯前端）**：
  - 不依赖 Rust 与 Tauri；
  - 历史记录存放于内存中，相关导出与配置备份通过浏览器下载实现。

---

#### 10. 国际化与主题

- 使用 `i18next` 管理中英文文案：
  - 所有可见文字均通过 `t()` 调用获取；
  - 支持运行时切换语言。
- 主题模式：
  - `light` / `dark` 双主题；
  - 通过 `data-theme` 属性与 CSS 变量配合实现；
  - 初始值从本地存储或系统偏好推断。
